{
    "input": "-- start template query57.tpl query 70 in stream 0\nwith /* TPC-DS query57.tpl 0.70 */ v1 as(\n select i_category, i_brand,\n        cc_name,\n        d_year, d_moy,\n        sum(cs_sales_price) sum_sales,\n        avg(sum(cs_sales_price)) over\n          (partition by i_category, i_brand,\n                     cc_name, d_year)\n          avg_monthly_sales,\n        rank() over\n          (partition by i_category, i_brand,\n                     cc_name\n           order by d_year, d_moy) rn\n from item, catalog_sales, date_dim, call_center\n where cs_item_sk = i_item_sk and\n       cs_sold_date_sk = d_date_sk and\n       cc_call_center_sk= cs_call_center_sk and\n       (\n         d_year = 2001 or\n         ( d_year = 2001-1 and d_moy =12) or\n         ( d_year = 2001+1 and d_moy =1)\n       )\n group by i_category, i_brand,\n          cc_name , d_year, d_moy),\n v2 as(\n select v1.cc_name\n        ,v1.d_year, v1.d_moy\n        ,v1.avg_monthly_sales\n        ,v1.sum_sales, v1_lag.sum_sales psum, v1_lead.sum_sales nsum\n from v1, v1 v1_lag, v1 v1_lead\n where v1.i_category = v1_lag.i_category and\n       v1.i_category = v1_lead.i_category and\n       v1.i_brand = v1_lag.i_brand and\n       v1.i_brand = v1_lead.i_brand and\n       v1. cc_name = v1_lag. cc_name and\n       v1. cc_name = v1_lead. cc_name and\n       v1.rn = v1_lag.rn + 1 and\n       v1.rn = v1_lead.rn - 1)\n  select  *\n from v2\n where  d_year = 2001 and\n        avg_monthly_sales > 0 and\n        case when avg_monthly_sales > 0 then abs(sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1\n order by sum_sales - avg_monthly_sales, psum\n limit 100",
    "query": [
        {
            "query": "/* START TEMPLATE QUERY57.TPL QUERY 70 IN STREAM 0 */ /* TPC-DS QUERY57.TPL 0.70 */ WITH V1 AS ( SELECT I_CATEGORY , I_BRAND , CC_NAME , D_YEAR , D_MOY , SUM ( CS_SALES_PRICE ) AS SUM_SALES , AVG ( SUM ( CS_SALES_PRICE ) ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , CC_NAME , D_YEAR ) AS AVG_MONTHLY_SALES , RANK ( ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , CC_NAME ORDER BY D_YEAR NULLS FIRST , D_MOY NULLS FIRST ) AS RN FROM ITEM , CATALOG_SALES , DATE_DIM , CALL_CENTER WHERE CS_ITEM_SK = I_ITEM_SK AND CS_SOLD_DATE_SK = D_DATE_SK AND CC_CALL_CENTER_SK = CS_CALL_CENTER_SK AND ( D_YEAR = 2001 OR ( D_YEAR = 2001 - 1 AND D_MOY = 12 ) OR ( D_YEAR = 2001 + 1 AND D_MOY = 1 ) ) GROUP BY I_CATEGORY , I_BRAND , CC_NAME , D_YEAR , D_MOY ) , V2 AS ( SELECT V1.CC_NAME , V1.D_YEAR , V1.D_MOY , V1.AVG_MONTHLY_SALES , V1.SUM_SALES , V1_LAG.SUM_SALES AS PSUM , V1_LEAD.SUM_SALES AS NSUM FROM V1 , V1 AS V1_LAG , V1 AS V1_LEAD WHERE V1.I_CATEGORY = V1_LAG.I_CATEGORY AND V1.I_CATEGORY = V1_LEAD.I_CATEGORY AND V1.I_BRAND = V1_LAG.I_BRAND AND V1.I_BRAND = V1_LEAD.I_BRAND AND V1.CC_NAME = V1_LAG.CC_NAME AND V1.CC_NAME = V1_LEAD.CC_NAME AND V1.RN = V1_LAG.RN + 1 AND V1.RN = V1_LEAD.RN - 1 ) SELECT * FROM V2 WHERE D_YEAR = 2001 AND AVG_MONTHLY_SALES > 0 AND CASE WHEN AVG_MONTHLY_SALES > 0 THEN ABS ( SUM_SALES - AVG_MONTHLY_SALES ) / AVG_MONTHLY_SALES ELSE NULL END > 0.1 ORDER BY SUM_SALES - AVG_MONTHLY_SALES NULLS FIRST , PSUM NULLS FIRST LIMIT 21",
            "preview": "\n/*                cc_name  d_year  d_moy  avg_monthly_sales  sum_sales       psum       nsum\n0        Mid Atlantic_3    2001      2         1460433.73  764505.02  868368.62  851924.25\n1        Mid Atlantic_2    2001      2         1461946.87  771957.29  853368.73  827903.16\n2        Mid Atlantic_1    2001      2         1456762.60  767737.53  854486.24  856667.10\n3       Hawaii/Alaska_1    2001      2         1448871.38  760064.57  853760.33  836497.41\n4            NY Metro_2    2001      2         1445398.96  756955.71  856747.14  840466.61\n5          Mid Atlantic    2001      2         1458180.10  769779.78  860621.05  834300.15\n6       North Midwest_1    2001      2         1457619.63  769572.08  847756.79  835881.70\n7   Pacific Northwest_1    2001      2         1444874.53  756849.98  865644.40  831898.54\n8     Pacific Northwest    2001      2         1447371.05  759970.27  849473.60  835758.52\n9            NY Metro_2    2001      2         1458136.49  771413.24  866302.91  837608.49\n10        North Midwest    2001      2         1463559.95  776849.32  849642.24  842954.65\n11           NY Metro_1    2001      2         1454699.53  768008.89  847684.78  845727.81\n12      North Midwest_1    2001      2         1441413.19  754915.32  853892.90  819424.53\n13  Pacific Northwest_2    2001      2         1451836.60  765872.34  875128.82  817996.35\n14       Mid Atlantic_2    2001      2         1449110.33  763444.56  861259.49  820893.10\n15    Pacific Northwest    2001      2         1460114.17  774736.09  868434.03  824560.15\n16           NY Metro_3    2001      2         1439563.85  754590.75  868110.97  824139.87\n17      North Midwest_3    2001      2         1447353.42  763813.89  860105.75  835003.80\n18       Mid Atlantic_1    2001      2         1443203.34  759672.39  852527.80  833372.35\n...*/",
            "retry_time": 0,
            "query_metrics": {
                "elapsed_time": 13.855267,
                "execution_time": 13.331232,
                "compile_time": 0.001263,
                "planning_time": 7.008476
            },
            "query_metrics_warm_up": {
                "elapsed_time": 15.819769,
                "execution_time": 15.20919,
                "compile_time": 0.001302,
                "planning_time": 9.070756
            }
        }
    ],
    "preview": "\n/*                cc_name  d_year  d_moy  avg_monthly_sales  sum_sales       psum       nsum\n0        Mid Atlantic_3    2001      2         1460433.73  764505.02  868368.62  851924.25\n1        Mid Atlantic_2    2001      2         1461946.87  771957.29  853368.73  827903.16\n2        Mid Atlantic_1    2001      2         1456762.60  767737.53  854486.24  856667.10\n3       Hawaii/Alaska_1    2001      2         1448871.38  760064.57  853760.33  836497.41\n4            NY Metro_2    2001      2         1445398.96  756955.71  856747.14  840466.61\n5          Mid Atlantic    2001      2         1458180.10  769779.78  860621.05  834300.15\n6       North Midwest_1    2001      2         1457619.63  769572.08  847756.79  835881.70\n7   Pacific Northwest_1    2001      2         1444874.53  756849.98  865644.40  831898.54\n8     Pacific Northwest    2001      2         1447371.05  759970.27  849473.60  835758.52\n9            NY Metro_2    2001      2         1458136.49  771413.24  866302.91  837608.49\n10        North Midwest    2001      2         1463559.95  776849.32  849642.24  842954.65\n11           NY Metro_1    2001      2         1454699.53  768008.89  847684.78  845727.81\n12      North Midwest_1    2001      2         1441413.19  754915.32  853892.90  819424.53\n13  Pacific Northwest_2    2001      2         1451836.60  765872.34  875128.82  817996.35\n14       Mid Atlantic_2    2001      2         1449110.33  763444.56  861259.49  820893.10\n15    Pacific Northwest    2001      2         1460114.17  774736.09  868434.03  824560.15\n16           NY Metro_3    2001      2         1439563.85  754590.75  868110.97  824139.87\n17      North Midwest_3    2001      2         1447353.42  763813.89  860105.75  835003.80\n18       Mid Atlantic_1    2001      2         1443203.34  759672.39  852527.80  833372.35\n...*/"
}