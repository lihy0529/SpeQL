{
    "input": "-- start template query47.tpl query 42 in stream 0\nwith /* TPC-DS query47.tpl 0.42 */ v1 as(\n select i_category, i_brand,\n        s_store_name, s_company_name,\n        d_year, d_moy,\n        sum(ss_sales_price) sum_sales,\n        avg(sum(ss_sales_price)) over\n          (partition by i_category, i_brand,\n                     s_store_name, s_company_name, d_year)\n          avg_monthly_sales,\n        rank() over\n          (partition by i_category, i_brand,\n                     s_store_name, s_company_name\n           order by d_year, d_moy) rn\n from item, store_sales, date_dim, store\n where ss_item_sk = i_item_sk and\n       ss_sold_date_sk = d_date_sk and\n       ss_store_sk = s_store_sk and\n       (\n         d_year = 2001 or\n         ( d_year = 2001-1 and d_moy =12) or\n         ( d_year = 2001+1 and d_moy =1)\n       )\n group by i_category, i_brand,\n          s_store_name, s_company_name,\n          d_year, d_moy),\n v2 as(\n select v1.s_store_name\n        ,v1.d_year, v1.d_moy\n        ,v1.avg_monthly_sales\n        ,v1.sum_sales, v1_lag.sum_sales psum, v1_lead.sum_sales nsum\n from v1, v1 v1_lag, v1 v1_lead\n where v1.i_category = v1_lag.i_category and\n       v1.i_category = v1_lead.i_category and\n       v1.i_brand = v1_lag.i_brand and\n       v1.i_brand = v1_lead.i_brand and\n       v1.s_store_name = v1_lag.s_store_name and\n       v1.s_store_name = v1_lead.s_store_name and\n       v1.s_company_name = v1_lag.s_company_name and\n       v1.s_company_name = v1_lead.s_company_name and\n       v1.rn = v1_lag.rn + 1 and\n       v1.rn = v1_lead.rn - 1)\n  select  *\n from v2\n where  d_year = 2001 and    \n        avg_monthly_sales > 0 and\n        case when avg_monthly_sales > 0 then abs(sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1\n order by sum_sales - avg_monthly_sales, sum_sales\n limit 100",
    "query": [
        {
            "query": "/* START TEMPLATE QUERY47.TPL QUERY 42 IN STREAM 0 */ /* TPC-DS QUERY47.TPL 0.42 */ WITH V1 AS ( SELECT I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR , D_MOY , SUM ( SS_SALES_PRICE ) AS SUM_SALES , AVG ( SUM ( SS_SALES_PRICE ) ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR ) AS AVG_MONTHLY_SALES , RANK ( ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME ORDER BY D_YEAR NULLS FIRST , D_MOY NULLS FIRST ) AS RN FROM ITEM , STORE_SALES , DATE_DIM , STORE WHERE SS_ITEM_SK = I_ITEM_SK AND SS_SOLD_DATE_SK = D_DATE_SK AND SS_STORE_SK = S_STORE_SK AND ( D_YEAR = 2001 OR ( D_YEAR = 2001 - 1 AND D_MOY = 12 ) OR ( D_YEAR = 2001 + 1 AND D_MOY = 1 ) ) GROUP BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR , D_MOY ) , V2 AS ( SELECT V1.S_STORE_NAME , V1.D_YEAR , V1.D_MOY , V1.AVG_MONTHLY_SALES , V1.SUM_SALES , V1_LAG.SUM_SALES AS PSUM , V1_LEAD.SUM_SALES AS NSUM FROM V1 , V1 AS V1_LAG , V1 AS V1_LEAD WHERE V1.I_CATEGORY = V1_LAG.I_CATEGORY AND V1.I_CATEGORY = V1_LEAD.I_CATEGORY AND V1.I_BRAND = V1_LAG.I_BRAND AND V1.I_BRAND = V1_LEAD.I_BRAND AND V1.S_STORE_NAME = V1_LAG.S_STORE_NAME AND V1.S_STORE_NAME = V1_LEAD.S_STORE_NAME AND V1.S_COMPANY_NAME = V1_LAG.S_COMPANY_NAME AND V1.S_COMPANY_NAME = V1_LEAD.S_COMPANY_NAME AND V1.RN = V1_LAG.RN + 1 AND V1.RN = V1_LEAD.RN - 1 ) SELECT * FROM V2 WHERE D_YEAR = 2001 AND AVG_MONTHLY_SALES > 0 AND CASE WHEN AVG_MONTHLY_SALES > 0 THEN ABS ( SUM_SALES - AVG_MONTHLY_SALES ) / AVG_MONTHLY_SALES ELSE NULL END > 0.1 ORDER BY SUM_SALES - AVG_MONTHLY_SALES NULLS FIRST , SUM_SALES NULLS FIRST LIMIT 21",
            "preview": "\n/*   s_store_name  d_year  d_moy  avg_monthly_sales   sum_sales        psum        nsum\n0          able    2001      2         5714487.21  3061177.33  3664614.24  3291388.25\n1           bar    2001      2         5723359.13  3076970.76  3634492.28  3288001.64\n2          able    2001      2         5659645.56  3018476.95  3604881.11  3215853.81\n3          able    2001      2         5635630.30  2998844.50  3609677.91  3249226.91\n4          able    2001      2         5626165.62  2991341.60  3579842.81  3212566.76\n5           bar    2001      2         5628312.12  2994303.37  3593377.37  3233465.51\n6           ese    2001      2         5636901.41  3003565.52  3585861.68  3229226.94\n7          able    2001      2         5680492.33  3048207.88  3626737.10  3296896.19\n8           bar    2001      2         5631599.91  3006558.75  3613627.69  3253744.11\n9          able    2001      2         5666786.87  3043376.88  3608564.69  3237346.28\n10         eing    2001      2         5586262.37  2964186.81  3576617.58  3208960.59\n11          bar    2001      2         5665263.96  3043838.15  3624987.63  3259728.32\n12         able    2001      2         5639181.32  3018184.58  3590367.08  3234546.81\n13         eing    2001      2         5637266.58  3017419.85  3569524.17  3234108.58\n14         able    2001      2         5627377.53  3014795.22  3617167.19  3217447.39\n15          bar    2001      2         5666648.04  3056207.40  3607520.63  3219716.68\n16          ese    2001      2         5575823.46  2967855.73  3554488.76  3206425.50\n17         eing    2001      2         5576638.91  2969698.53  3563410.57  3202366.61\n18          bar    2001      2         5642972.70  3036830.09  3613734.06  3232879.92\n...*/",
            "retry_time": 0,
            "query_metrics": {
                "elapsed_time": 39.452326,
                "execution_time": 39.008053,
                "compile_time": 0.00116,
                "planning_time": 18.8423
            },
            "query_metrics_warm_up": {
                "elapsed_time": 38.853029,
                "execution_time": 38.33691,
                "compile_time": 0.001165,
                "planning_time": 19.96311
            }
        }
    ],
    "preview": "\n/*   s_store_name  d_year  d_moy  avg_monthly_sales   sum_sales        psum        nsum\n0          able    2001      2         5714487.21  3061177.33  3664614.24  3291388.25\n1           bar    2001      2         5723359.13  3076970.76  3634492.28  3288001.64\n2          able    2001      2         5659645.56  3018476.95  3604881.11  3215853.81\n3          able    2001      2         5635630.30  2998844.50  3609677.91  3249226.91\n4          able    2001      2         5626165.62  2991341.60  3579842.81  3212566.76\n5           bar    2001      2         5628312.12  2994303.37  3593377.37  3233465.51\n6           ese    2001      2         5636901.41  3003565.52  3585861.68  3229226.94\n7          able    2001      2         5680492.33  3048207.88  3626737.10  3296896.19\n8           bar    2001      2         5631599.91  3006558.75  3613627.69  3253744.11\n9          able    2001      2         5666786.87  3043376.88  3608564.69  3237346.28\n10         eing    2001      2         5586262.37  2964186.81  3576617.58  3208960.59\n11          bar    2001      2         5665263.96  3043838.15  3624987.63  3259728.32\n12         able    2001      2         5639181.32  3018184.58  3590367.08  3234546.81\n13         eing    2001      2         5637266.58  3017419.85  3569524.17  3234108.58\n14         able    2001      2         5627377.53  3014795.22  3617167.19  3217447.39\n15          bar    2001      2         5666648.04  3056207.40  3607520.63  3219716.68\n16          ese    2001      2         5575823.46  2967855.73  3554488.76  3206425.50\n17         eing    2001      2         5576638.91  2969698.53  3563410.57  3202366.61\n18          bar    2001      2         5642972.70  3036830.09  3613734.06  3232879.92\n...*/"
}