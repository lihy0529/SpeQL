{
    "input": "-- start template query47.tpl query 42 in stream 0\nwith /* TPC-DS query47.tpl 0.42 */ v1 as(\n select i_category, i_brand,\n        s_store_name, s_company_name,\n        d_year, d_moy,\n        sum(ss_sales_price) sum_sales,\n        avg(sum(ss_sales_price)) over\n          (partition by i_category, i_brand,\n                     s_store_name, s_company_name, d_year)\n          avg_monthly_sales,\n        rank() over\n          (partition by i_category, i_brand,\n                     s_store_name, s_company_name\n           order by d_year, d_moy) rn\n from item, store_sales, date_dim, store\n where ss_item_sk = i_item_sk and\n       ss_sold_date_sk = d_date_sk and\n       ss_store_sk = s_store_sk and\n       (\n         d_year = 2001 or\n         ( d_year = 2001-1 and d_moy =12) or\n         ( d_year = 2001+1 and d_moy =1)\n       )\n group by i_category, i_brand,\n          s_store_name, s_company_name,\n          d_year, d_moy),\n v2 as(\n select v1.s_store_name\n        ,v1.d_year, v1.d_moy\n        ,v1.avg_monthly_sales\n        ,v1.sum_sales, v1_lag.sum_sales psum, v1_lead.sum_sales nsum\n from v1, v1 v1_lag, v1 v1_lead\n where v1.i_category = v1_lag.i_category and\n       v1.i_category = v1_lead.i_category and\n       v1.i_brand = v1_lag.i_brand and\n       v1.i_brand = v1_lead.i_brand and\n       v1.s_store_name = v1_lag.s_store_name and\n       v1.s_store_name = v1_lead.s_store_name and\n       v1.s_company_name = v1_lag.s_company_name and\n       v1.s_company_name = v1_lead.s_company_name and\n       v1.rn = v1_lag.rn + 1 and\n       v1.rn = v1_lead.rn - 1)\n  select  *\n from v2\n where  d_year = 2001 and    \n        avg_monthly_sales > 0 and\n        case when avg_monthly_sales > 0 then abs(sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1\n order by sum_sales - avg_monthly_sales, sum_sales\n limit 100",
    "query": [
        {
            "query": "/* START TEMPLATE QUERY47.TPL QUERY 42 IN STREAM 0 */ /* TPC-DS QUERY47.TPL 0.42 */ WITH V1 AS ( SELECT I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR , D_MOY , SUM ( SS_SALES_PRICE ) AS SUM_SALES , AVG ( SUM ( SS_SALES_PRICE ) ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR ) AS AVG_MONTHLY_SALES , RANK ( ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME ORDER BY D_YEAR NULLS FIRST , D_MOY NULLS FIRST ) AS RN FROM ITEM , STORE_SALES , DATE_DIM , STORE WHERE SS_ITEM_SK = I_ITEM_SK AND SS_SOLD_DATE_SK = D_DATE_SK AND SS_STORE_SK = S_STORE_SK AND ( D_YEAR = 2001 OR ( D_YEAR = 2001 - 1 AND D_MOY = 12 ) OR ( D_YEAR = 2001 + 1 AND D_MOY = 1 ) ) GROUP BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR , D_MOY ) , V2 AS ( SELECT V1.S_STORE_NAME , V1.D_YEAR , V1.D_MOY , V1.AVG_MONTHLY_SALES , V1.SUM_SALES , V1_LAG.SUM_SALES AS PSUM , V1_LEAD.SUM_SALES AS NSUM FROM V1 , V1 AS V1_LAG , V1 AS V1_LEAD WHERE V1.I_CATEGORY = V1_LAG.I_CATEGORY AND V1.I_CATEGORY = V1_LEAD.I_CATEGORY AND V1.I_BRAND = V1_LAG.I_BRAND AND V1.I_BRAND = V1_LEAD.I_BRAND AND V1.S_STORE_NAME = V1_LAG.S_STORE_NAME AND V1.S_STORE_NAME = V1_LEAD.S_STORE_NAME AND V1.S_COMPANY_NAME = V1_LAG.S_COMPANY_NAME AND V1.S_COMPANY_NAME = V1_LEAD.S_COMPANY_NAME AND V1.RN = V1_LAG.RN + 1 AND V1.RN = V1_LEAD.RN - 1 ) SELECT * FROM V2 WHERE D_YEAR = 2001 AND AVG_MONTHLY_SALES > 0 AND CASE WHEN AVG_MONTHLY_SALES > 0 THEN ABS ( SUM_SALES - AVG_MONTHLY_SALES ) / AVG_MONTHLY_SALES ELSE NULL END > 0.1 ORDER BY SUM_SALES - AVG_MONTHLY_SALES NULLS FIRST , SUM_SALES NULLS FIRST LIMIT 21",
            "preview": "\n/*   s_store_name  d_year  d_moy  avg_monthly_sales  sum_sales      psum      nsum\n0          eing    2001      2           58721.20   27048.97  33909.25  34647.93\n1          able    2001      3           59157.76   29194.68  31501.37  37174.55\n2          able    2001      3           57395.37   27480.89  30086.16  33222.64\n3           ese    2001      2           57715.07   28437.81  36185.12  31695.78\n4          eing    2001      2           57681.47   28801.10  36126.33  32465.18\n5          eing    2001      2           58729.62   29860.31  35556.77  34094.84\n6          eing    2001      2           58476.74   29608.18  35405.35  37592.40\n7           ese    2001      2           57611.09   28769.22  36092.40  29527.30\n8           bar    2001      2           58227.01   29409.10  37550.75  36473.82\n9          able    2001      3           55708.20   26913.77  32319.94  35682.95\n10          ese    2001      2           56990.28   28339.38  38281.82  32087.03\n11         able    2001      3           58846.95   30363.97  31295.05  36355.93\n12         able    2001      3           58513.79   30066.75  31152.70  35776.47\n13         eing    2001      2           57154.48   28771.31  36661.39  33231.16\n14         eing    2001      2           56756.53   28406.10  33882.44  30264.74\n15          ese    2001      2           57625.25   29290.68  36502.64  33761.33\n16         able    2001      3           57947.64   29651.98  30809.67  32288.61\n17         able    2001      3           56166.97   27943.13  30893.04  32784.19\n18          ese    2001      3           57611.09   29527.30  28769.22  33786.54\n...*/",
            "retry_time": 0,
            "query_metrics": {
                "elapsed_time": 1.040623,
                "execution_time": 0.685985,
                "compile_time": 0.001077,
                "planning_time": 0.643329
            },
            "query_metrics_warm_up": {
                "elapsed_time": 1.219762,
                "execution_time": 0.795072,
                "compile_time": 0.001113,
                "planning_time": 0.799081
            }
        }
    ],
    "preview": "\n/*   s_store_name  d_year  d_moy  avg_monthly_sales  sum_sales      psum      nsum\n0          eing    2001      2           58721.20   27048.97  33909.25  34647.93\n1          able    2001      3           59157.76   29194.68  31501.37  37174.55\n2          able    2001      3           57395.37   27480.89  30086.16  33222.64\n3           ese    2001      2           57715.07   28437.81  36185.12  31695.78\n4          eing    2001      2           57681.47   28801.10  36126.33  32465.18\n5          eing    2001      2           58729.62   29860.31  35556.77  34094.84\n6          eing    2001      2           58476.74   29608.18  35405.35  37592.40\n7           ese    2001      2           57611.09   28769.22  36092.40  29527.30\n8           bar    2001      2           58227.01   29409.10  37550.75  36473.82\n9          able    2001      3           55708.20   26913.77  32319.94  35682.95\n10          ese    2001      2           56990.28   28339.38  38281.82  32087.03\n11         able    2001      3           58846.95   30363.97  31295.05  36355.93\n12         able    2001      3           58513.79   30066.75  31152.70  35776.47\n13         eing    2001      2           57154.48   28771.31  36661.39  33231.16\n14         eing    2001      2           56756.53   28406.10  33882.44  30264.74\n15          ese    2001      2           57625.25   29290.68  36502.64  33761.33\n16         able    2001      3           57947.64   29651.98  30809.67  32288.61\n17         able    2001      3           56166.97   27943.13  30893.04  32784.19\n18          ese    2001      3           57611.09   29527.30  28769.22  33786.54\n...*/"
}