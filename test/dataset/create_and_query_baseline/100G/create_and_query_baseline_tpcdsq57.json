{
    "input": "-- start template query57.tpl query 70 in stream 0\nwith /* TPC-DS query57.tpl 0.70 */ v1 as(\n select i_category, i_brand,\n        cc_name,\n        d_year, d_moy,\n        sum(cs_sales_price) sum_sales,\n        avg(sum(cs_sales_price)) over\n          (partition by i_category, i_brand,\n                     cc_name, d_year)\n          avg_monthly_sales,\n        rank() over\n          (partition by i_category, i_brand,\n                     cc_name\n           order by d_year, d_moy) rn\n from item, catalog_sales, date_dim, call_center\n where cs_item_sk = i_item_sk and\n       cs_sold_date_sk = d_date_sk and\n       cc_call_center_sk= cs_call_center_sk and\n       (\n         d_year = 2001 or\n         ( d_year = 2001-1 and d_moy =12) or\n         ( d_year = 2001+1 and d_moy =1)\n       )\n group by i_category, i_brand,\n          cc_name , d_year, d_moy),\n v2 as(\n select v1.cc_name\n        ,v1.d_year, v1.d_moy\n        ,v1.avg_monthly_sales\n        ,v1.sum_sales, v1_lag.sum_sales psum, v1_lead.sum_sales nsum\n from v1, v1 v1_lag, v1 v1_lead\n where v1.i_category = v1_lag.i_category and\n       v1.i_category = v1_lead.i_category and\n       v1.i_brand = v1_lag.i_brand and\n       v1.i_brand = v1_lead.i_brand and\n       v1. cc_name = v1_lag. cc_name and\n       v1. cc_name = v1_lead. cc_name and\n       v1.rn = v1_lag.rn + 1 and\n       v1.rn = v1_lead.rn - 1)\n  select  *\n from v2\n where  d_year = 2001 and\n        avg_monthly_sales > 0 and\n        case when avg_monthly_sales > 0 then abs(sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1\n order by sum_sales - avg_monthly_sales, psum\n limit 100",
    "query": [
        {
            "query": "/* START TEMPLATE QUERY57.TPL QUERY 70 IN STREAM 0 */ /* TPC-DS QUERY57.TPL 0.70 */ WITH V1 AS ( SELECT I_CATEGORY , I_BRAND , CC_NAME , D_YEAR , D_MOY , SUM ( CS_SALES_PRICE ) AS SUM_SALES , AVG ( SUM ( CS_SALES_PRICE ) ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , CC_NAME , D_YEAR ) AS AVG_MONTHLY_SALES , RANK ( ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , CC_NAME ORDER BY D_YEAR NULLS FIRST , D_MOY NULLS FIRST ) AS RN FROM ITEM , CATALOG_SALES , DATE_DIM , CALL_CENTER WHERE CS_ITEM_SK = I_ITEM_SK AND CS_SOLD_DATE_SK = D_DATE_SK AND CC_CALL_CENTER_SK = CS_CALL_CENTER_SK AND ( D_YEAR = 2001 OR ( D_YEAR = 2001 - 1 AND D_MOY = 12 ) OR ( D_YEAR = 2001 + 1 AND D_MOY = 1 ) ) GROUP BY I_CATEGORY , I_BRAND , CC_NAME , D_YEAR , D_MOY ) , V2 AS ( SELECT V1.CC_NAME , V1.D_YEAR , V1.D_MOY , V1.AVG_MONTHLY_SALES , V1.SUM_SALES , V1_LAG.SUM_SALES AS PSUM , V1_LEAD.SUM_SALES AS NSUM FROM V1 , V1 AS V1_LAG , V1 AS V1_LEAD WHERE V1.I_CATEGORY = V1_LAG.I_CATEGORY AND V1.I_CATEGORY = V1_LEAD.I_CATEGORY AND V1.I_BRAND = V1_LAG.I_BRAND AND V1.I_BRAND = V1_LEAD.I_BRAND AND V1.CC_NAME = V1_LAG.CC_NAME AND V1.CC_NAME = V1_LEAD.CC_NAME AND V1.RN = V1_LAG.RN + 1 AND V1.RN = V1_LEAD.RN - 1 ) SELECT * FROM V2 WHERE D_YEAR = 2001 AND AVG_MONTHLY_SALES > 0 AND CASE WHEN AVG_MONTHLY_SALES > 0 THEN ABS ( SUM_SALES - AVG_MONTHLY_SALES ) / AVG_MONTHLY_SALES ELSE NULL END > 0.1 ORDER BY SUM_SALES - AVG_MONTHLY_SALES NULLS FIRST , PSUM NULLS FIRST LIMIT 21",
            "preview": "\n/*              cc_name  d_year  d_moy  avg_monthly_sales  sum_sales       psum       nsum\n0   Pacific Northwest    2001      2          203956.23  102300.20  118349.96  117588.24\n1       North Midwest    2001      2          202706.67  101215.32  119432.70  117915.30\n2        Mid Atlantic    2001      2          200325.10   99077.31  122018.66  119580.17\n3        California_1    2001      4          203863.79  103054.10  115334.03  124339.28\n4            NY Metro    2001      2          199647.14   99248.37  122540.27  110327.28\n5            NY Metro    2001      2          202144.54  101984.60  120736.47  108033.37\n6     Hawaii/Alaska_1    2001      2          195071.19   95022.03  108591.79  108425.00\n7          NY Metro_1    2001      2          198795.50   99160.86  116308.99  114580.02\n8      Mid Atlantic_2    2001      2          201123.38  101575.81  122156.64  112986.52\n9        Mid Atlantic    2001      2          202423.77  102880.67  123576.60  120991.51\n10     Mid Atlantic_2    2001      2          201165.27  101926.47  123356.71  118424.80\n11       Mid Atlantic    2001      2          207677.93  108525.76  121070.82  119950.76\n12       California_1    2001      2          199948.00  100797.86  121993.65  114258.49\n13           NY Metro    2001      2          201697.77  102573.30  120853.92  116848.41\n14     Mid Atlantic_2    2001      2          198192.58   99075.10  117885.31  108458.21\n15    Hawaii/Alaska_1    2001      2          203223.67  104143.82  119861.91  116595.66\n16     Mid Atlantic_2    2001      2          195721.45   96929.79  119299.79  115838.97\n17       California_1    2001      2          207740.46  109060.36  118611.33  116892.29\n18     Mid Atlantic_2    2001      2          201446.04  102906.19  119755.66  117782.54\n...*/",
            "retry_time": 0,
            "query_metrics": {
                "elapsed_time": 2.943359,
                "execution_time": 2.496975,
                "compile_time": 0.001144,
                "planning_time": 1.557668
            },
            "query_metrics_warm_up": {
                "elapsed_time": 4.432758,
                "execution_time": 3.91404,
                "compile_time": 0.003391,
                "planning_time": 3.01133
            }
        }
    ],
    "preview": "\n/*              cc_name  d_year  d_moy  avg_monthly_sales  sum_sales       psum       nsum\n0   Pacific Northwest    2001      2          203956.23  102300.20  118349.96  117588.24\n1       North Midwest    2001      2          202706.67  101215.32  119432.70  117915.30\n2        Mid Atlantic    2001      2          200325.10   99077.31  122018.66  119580.17\n3        California_1    2001      4          203863.79  103054.10  115334.03  124339.28\n4            NY Metro    2001      2          199647.14   99248.37  122540.27  110327.28\n5            NY Metro    2001      2          202144.54  101984.60  120736.47  108033.37\n6     Hawaii/Alaska_1    2001      2          195071.19   95022.03  108591.79  108425.00\n7          NY Metro_1    2001      2          198795.50   99160.86  116308.99  114580.02\n8      Mid Atlantic_2    2001      2          201123.38  101575.81  122156.64  112986.52\n9        Mid Atlantic    2001      2          202423.77  102880.67  123576.60  120991.51\n10     Mid Atlantic_2    2001      2          201165.27  101926.47  123356.71  118424.80\n11       Mid Atlantic    2001      2          207677.93  108525.76  121070.82  119950.76\n12       California_1    2001      2          199948.00  100797.86  121993.65  114258.49\n13           NY Metro    2001      2          201697.77  102573.30  120853.92  116848.41\n14     Mid Atlantic_2    2001      2          198192.58   99075.10  117885.31  108458.21\n15    Hawaii/Alaska_1    2001      2          203223.67  104143.82  119861.91  116595.66\n16     Mid Atlantic_2    2001      2          195721.45   96929.79  119299.79  115838.97\n17       California_1    2001      2          207740.46  109060.36  118611.33  116892.29\n18     Mid Atlantic_2    2001      2          201446.04  102906.19  119755.66  117782.54\n...*/"
}