{
    "input": "-- start template query47.tpl query 42 in stream 0\nwith /* TPC-DS query47.tpl 0.42 */ v1 as(\n select i_category, i_brand,\n        s_store_name, s_company_name,\n        d_year, d_moy,\n        sum(ss_sales_price) sum_sales,\n        avg(sum(ss_sales_price)) over\n          (partition by i_category, i_brand,\n                     s_store_name, s_company_name, d_year)\n          avg_monthly_sales,\n        rank() over\n          (partition by i_category, i_brand,\n                     s_store_name, s_company_name\n           order by d_year, d_moy) rn\n from item, store_sales, date_dim, store\n where ss_item_sk = i_item_sk and\n       ss_sold_date_sk = d_date_sk and\n       ss_store_sk = s_store_sk and\n       (\n         d_year = 2001 or\n         ( d_year = 2001-1 and d_moy =12) or\n         ( d_year = 2001+1 and d_moy =1)\n       )\n group by i_category, i_brand,\n          s_store_name, s_company_name,\n          d_year, d_moy),\n v2 as(\n select v1.s_store_name\n        ,v1.d_year, v1.d_moy\n        ,v1.avg_monthly_sales\n        ,v1.sum_sales, v1_lag.sum_sales psum, v1_lead.sum_sales nsum\n from v1, v1 v1_lag, v1 v1_lead\n where v1.i_category = v1_lag.i_category and\n       v1.i_category = v1_lead.i_category and\n       v1.i_brand = v1_lag.i_brand and\n       v1.i_brand = v1_lead.i_brand and\n       v1.s_store_name = v1_lag.s_store_name and\n       v1.s_store_name = v1_lead.s_store_name and\n       v1.s_company_name = v1_lag.s_company_name and\n       v1.s_company_name = v1_lead.s_company_name and\n       v1.rn = v1_lag.rn + 1 and\n       v1.rn = v1_lead.rn - 1)\n  select  *\n from v2\n where  d_year = 2001 and    \n        avg_monthly_sales > 0 and\n        case when avg_monthly_sales > 0 then abs(sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1\n order by sum_sales - avg_monthly_sales, sum_sales\n limit 100",
    "query": [
        {
            "query": "/* START TEMPLATE QUERY47.TPL QUERY 42 IN STREAM 0 */ /* TPC-DS QUERY47.TPL 0.42 */ WITH V1 AS ( SELECT I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR , D_MOY , SUM ( SS_SALES_PRICE ) AS SUM_SALES , AVG ( SUM ( SS_SALES_PRICE ) ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR ) AS AVG_MONTHLY_SALES , RANK ( ) OVER ( PARTITION BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME ORDER BY D_YEAR NULLS FIRST , D_MOY NULLS FIRST ) AS RN FROM ITEM , STORE_SALES , DATE_DIM , STORE WHERE SS_ITEM_SK = I_ITEM_SK AND SS_SOLD_DATE_SK = D_DATE_SK AND SS_STORE_SK = S_STORE_SK AND ( D_YEAR = 2001 OR ( D_YEAR = 2001 - 1 AND D_MOY = 12 ) OR ( D_YEAR = 2001 + 1 AND D_MOY = 1 ) ) GROUP BY I_CATEGORY , I_BRAND , S_STORE_NAME , S_COMPANY_NAME , D_YEAR , D_MOY ) , V2 AS ( SELECT V1.S_STORE_NAME , V1.D_YEAR , V1.D_MOY , V1.AVG_MONTHLY_SALES , V1.SUM_SALES , V1_LAG.SUM_SALES AS PSUM , V1_LEAD.SUM_SALES AS NSUM FROM V1 , V1 AS V1_LAG , V1 AS V1_LEAD WHERE V1.I_CATEGORY = V1_LAG.I_CATEGORY AND V1.I_CATEGORY = V1_LEAD.I_CATEGORY AND V1.I_BRAND = V1_LAG.I_BRAND AND V1.I_BRAND = V1_LEAD.I_BRAND AND V1.S_STORE_NAME = V1_LAG.S_STORE_NAME AND V1.S_STORE_NAME = V1_LEAD.S_STORE_NAME AND V1.S_COMPANY_NAME = V1_LAG.S_COMPANY_NAME AND V1.S_COMPANY_NAME = V1_LEAD.S_COMPANY_NAME AND V1.RN = V1_LAG.RN + 1 AND V1.RN = V1_LEAD.RN - 1 ) SELECT * FROM V2 WHERE D_YEAR = 2001 AND AVG_MONTHLY_SALES > 0 AND CASE WHEN AVG_MONTHLY_SALES > 0 THEN ABS ( SUM_SALES - AVG_MONTHLY_SALES ) / AVG_MONTHLY_SALES ELSE NULL END > 0.1 ORDER BY SUM_SALES - AVG_MONTHLY_SALES NULLS FIRST , SUM_SALES NULLS FIRST LIMIT 21",
            "preview": "\n/*   s_store_name  d_year  d_moy  avg_monthly_sales  sum_sales       psum       nsum\n0           bar    2001      2          570487.02  294284.04  369180.32  326952.61\n1           bar    2001      2          580302.65  305548.57  380724.71  336397.73\n2          eing    2001      2          582564.53  309509.50  355335.26  338902.44\n3          able    2001      2          580341.03  309054.37  371685.41  329906.21\n4           bar    2001      2          572126.31  301690.76  371659.70  333368.52\n5          able    2001      2          570628.86  301820.24  357343.34  320231.74\n6           bar    2001      2          562626.20  295384.94  358211.82  325352.25\n7           bar    2001      2          556830.45  289816.35  362881.07  321463.44\n8          eing    2001      2          571126.70  304312.88  355494.75  323267.13\n9           bar    2001      2          561916.51  295180.72  363520.40  322866.87\n10          bar    2001      2          565240.50  298824.82  361230.91  321276.70\n11         able    2001      2          564032.38  298387.75  367604.30  318619.41\n12         eing    2001      2          558565.56  293358.20  354235.03  316085.53\n13         able    2001      2          561085.07  296506.74  360325.31  324160.52\n14         eing    2001      2          571754.17  307674.66  358156.67  323777.15\n15         able    2001      2          561977.11  298119.58  361474.84  320396.97\n16          bar    2001      2          561878.08  298037.02  366130.06  329939.31\n17         able    2001      2          567293.08  303472.56  365649.59  321414.37\n18         able    2001      2          568231.46  304588.38  360794.29  321921.72\n...*/",
            "retry_time": 0,
            "query_metrics": {
                "elapsed_time": 4.60455,
                "execution_time": 4.184811,
                "compile_time": 0.00123,
                "planning_time": 2.400715
            },
            "query_metrics_warm_up": {
                "elapsed_time": 4.70372,
                "execution_time": 4.214752,
                "compile_time": 0.001195,
                "planning_time": 2.560891
            }
        }
    ],
    "preview": "\n/*   s_store_name  d_year  d_moy  avg_monthly_sales  sum_sales       psum       nsum\n0           bar    2001      2          570487.02  294284.04  369180.32  326952.61\n1           bar    2001      2          580302.65  305548.57  380724.71  336397.73\n2          eing    2001      2          582564.53  309509.50  355335.26  338902.44\n3          able    2001      2          580341.03  309054.37  371685.41  329906.21\n4           bar    2001      2          572126.31  301690.76  371659.70  333368.52\n5          able    2001      2          570628.86  301820.24  357343.34  320231.74\n6           bar    2001      2          562626.20  295384.94  358211.82  325352.25\n7           bar    2001      2          556830.45  289816.35  362881.07  321463.44\n8          eing    2001      2          571126.70  304312.88  355494.75  323267.13\n9           bar    2001      2          561916.51  295180.72  363520.40  322866.87\n10          bar    2001      2          565240.50  298824.82  361230.91  321276.70\n11         able    2001      2          564032.38  298387.75  367604.30  318619.41\n12         eing    2001      2          558565.56  293358.20  354235.03  316085.53\n13         able    2001      2          561085.07  296506.74  360325.31  324160.52\n14         eing    2001      2          571754.17  307674.66  358156.67  323777.15\n15         able    2001      2          561977.11  298119.58  361474.84  320396.97\n16          bar    2001      2          561878.08  298037.02  366130.06  329939.31\n17         able    2001      2          567293.08  303472.56  365649.59  321414.37\n18         able    2001      2          568231.46  304588.38  360794.29  321921.72\n...*/"
}